{% extends "base.html" %}

{% block content %}
    {% for team_id, team_data in teams_competency_data.items() %}
    {% set team = team_data.team %}
    {% set team_members = team_data.members %}
    {% set competency_matrix = team_data.competency_matrix %}
    <h1 class="mb-4">Matrice des Compétences de l'Équipe {{ team.name }}</h1>
    <p>Vue d'overview des compétences et de leur statut pour les membres de votre équipe.</p>

    <div class="mb-3">
        <label for="competencyFilter-{{ team.id }}" class="form-label">Filter by:</label>
        <select class="form-select competency-filter" id="competencyFilter-{{ team.id }}" data-table-id="team-competencies-table-{{ team.id }}">
            <option value="">Montrer tous</option>
            <option value="ct-issue">Problème de Formation Continue</option>
            <option value="needs-recycling">Compétences à revoir</option>
            <option value="hide-no-trained">Masquer les compétences sans membre formé</option>
        </select>
    </div>

    {% if team_members %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped team-competencies-table" id="team-competencies-table-{{ team.id }}" width="100%" cellspacing="0">
                                            <thead>
                                                <tr>
                                                    <th>Skill</th>
                                                    {% for member in team_data.members %}
                                                        <th>{{ member.full_name }}</th>
                                                    {% endfor %}
                                                </tr>
                                            </thead>                            <tbody>
                                {% for skill in team_data.all_skills %}
                                    <tr data-skill-id="{{ skill.id }}">
                                        <td>{{ skill.name }}</td>
                                        {% for member in team_data.members %}
                                            {% set comp_info = team_data.skill_competency_matrix[skill.id].member_competencies[member.id] %}
                                            <td>
                                                {% if comp_info.competency %}
                                                    Level: {{ comp_info.competency.level }}<br>
                                                    Last Practice: {{ comp_info.latest_practice_date.strftime('%Y-%m-%d') if comp_info.latest_practice_date else 'N/A' }}<br>
                                                    {% if comp_info.needs_recycling %}
                                                        <span class="badge bg-danger">Recycling Due: {{ comp_info.recycling_due_date.strftime('%Y-%m-%d') }}</span>
                                                    {% elif comp_info.recycling_due_date %}
                                                        <span class="badge bg-warning">Recycling: {{ comp_info.recycling_due_date.strftime('%Y-%m-%d') }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>

            </table>
        </div>
        <script>
            // Make skillsWithCompetentMembersIds available to JavaScript for this team
            window.skillsWithCompetentMembersIds_{{ team.id }} = {{ team_data.skills_with_competent_members_ids|tojson }};
        </script>
    {% else %}
        <p>Votre équipe n'a actuellement aucun membre.</p>
    {% endif %}
    {% endfor %}

    <a href="{{ url_for('dashboard.user_profile', username=current_user.full_name) }}" class="btn btn-secondary mt-3">Retour au Dashboard</a>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
    
        // Store tables in an object
        var dataTables = {};
    
        // Initialize each table
        document.querySelectorAll('.team-competencies-table').forEach(function(table) {
            var tableId = table.getAttribute('id');
            dataTables[tableId] = new DataTable(table, {
                responsive: true
            });
        });
    
        // Custom filter for DataTables
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var tableId = settings.sTableId;
                var filterValue = $('#competencyFilter-' + tableId.split('-').pop()).val();
    
                if (filterValue === '') {
                    return true; // Show all rows
                }
                
                var row = settings.aoData[dataIndex].nTr; // Get the row node
                if (filterValue === 'ct-issue') {
                    return $(row).find('.ct-status-cell .badge.bg-warning, .ct-status-cell .badge.bg-danger').length > 0;
                } else if (filterValue === 'needs-recycling') {
                    return $(row).find('.needs-recycling-cell').length > 0;
                } else if (filterValue === 'hide-no-trained') {
                    var skillId = parseInt($(row).data('skill-id'), 10);
                    var teamId = tableId.split('-').pop();
                    var skillsWithCompetentMembersIds = window['skillsWithCompetentMembersIds_' + teamId] || [];
                    if (!Array.isArray(skillsWithCompetentMembersIds)) {
                        skillsWithCompetentMembersIds = [];
                    }
                    return skillsWithCompetentMembersIds.includes(skillId);
                }
                return true;
            }
        );
    
        // Attach event listener to all filter dropdowns
        document.querySelectorAll('.competency-filter').forEach(function(filter) {
            filter.addEventListener('change', function() {
                var tableId = this.getAttribute('data-table-id');
                dataTables[tableId].draw();
            });
        });
    });
    </script>
{% endblock %}
