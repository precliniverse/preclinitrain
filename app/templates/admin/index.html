{% extends "base.html" %}

{% block content %}
    <h1 class="mb-4">Administrator Dashboard</h1>

    <!-- Section 1: Key Metric Cards -->
    <div class="row">
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.list_training_requests') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Pending Training</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_requests_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-inbox fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.pending_users') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Users Pending Approval</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_user_approvals_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.tutor_less_skills_report') }}" class="card border-left-warning shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Skills without Tutor</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ skills_without_tutors_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chalkboard-teacher fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{% if recycling_needed_count > 0 %}{{ url_for('admin.recycling_report') }}{% else %}#__{% endif %}" class="card border-left-danger shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">Recycling Required</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ users_needing_recycling|length }} users / {{ recycling_needed_count }} skills</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-sync-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.validate_external_trainings') }}" class="card border-left-success shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">External Trainings to Validate</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ pending_external_trainings_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_training_sessions') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Next session</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if next_session %}
                                    {{ next_session.start_time.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    None
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_training_sessions', filter='to_be_finalized') }}" class="card border-left-warning shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Sessions to be finalized</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ sessions_to_be_finalized_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.proposed_skills') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Proposed skills</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ proposed_skills_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-lightbulb fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <div class="col-md-4 mb-4">
            <div class="card text-white bg-danger shadow">
                <div class="card-body">
                    <h5 class="card-title">Pending FC Validations</h5>
                    <p class="card-text display-4">{{ pending_continuous_training_validations_count }}</p>
                    <a href="{{ url_for('admin.validate_continuous_trainings') }}" class="text-white stretched-link">Validate attendances</a>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-4">
            <div class="card text-white bg-secondary shadow">
                <div class="card-body">
                    <h5 class="card-title">Pending FC Event Requests</h5>
                    <p class="card-text display-4">{{ pending_continuous_event_requests_count }}</p>
                    <a href="{{ url_for('admin.manage_continuous_training_events') }}" class="text-white stretched-link">Manage events</a>
                </div>
            </div>
        </div>

        <!-- New card for Continuous Training Compliance Report -->
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.continuous_training_compliance_report') }}" class="card border-left-primary shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">FC Compliance Report</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800"><i class="fas fa-chart-line"></i></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clipboard-list fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>

        <!-- New card for Managing Continuous Training Events -->
        <div class="col-lg-3 col-md-6 mb-4">
            <a href="{{ url_for('admin.manage_continuous_training_events') }}" class="card border-left-info shadow h-100 py-2 text-decoration-none">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Manage FC Events</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800"><i class="fas fa-calendar-plus"></i></div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <!-- Section: Team Management -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Team Management</h6>
            <button class="btn btn-primary btn-sm" id="add-team-btn">Create a team</button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="teams-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Nb Members</th>
                            <th>Team Leads</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        <tr>
                            <td>{{ team.name }}</td>
                            <td>{{ team.members|length }}</td>
                            <td>
                                {% for lead in team.team_leads %}
                                    <a href="{{ url_for('dashboard.user_profile', username=lead.full_name) }}" class="badge bg-primary text-decoration-none">{{ lead.full_name }}</a>
                                {% else %}
                                    None
                                {% endfor %}
                            </td>
                            <td>
                                <a href="{{ url_for('admin.edit_team', id=team.id) }}" class="btn btn-sm btn-warning" title="Edit"><i class="fa fa-edit"></i></a>
                                <button class="btn btn-sm btn-info add-user-to-team-btn" data-team-id="{{ team.id }}" data-team-name="{{ team.name }}" title="Add User to Team"><i class="fas fa-user-plus"></i></button>
                                <form action="{{ url_for('admin.delete_team', id=team.id) }}" method="post" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-danger" title="Delete"><i class="fa fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section 2: User Management Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">User Management</h6>
            <div>
                <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#import-users-modal">Import</button>
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('admin.export_users_xlsx') }}">Export Excel</a></li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-sm" id="add-user-btn">Create a user</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="users-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Team</th>
                            <th>Roles</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr id="user-row-{{ user.id }}">
                            <td>{{ user.full_name }}</td>
                            <td>{{ user.email }}</td>
                            <td>
                                {% for team in user.teams %}
                                    <span class="badge bg-secondary">{{ team.name }}</span>
                                {% else %}
                                    None
                                {% endfor %}
                            </td>
                            <td>
                                {% if user.is_admin %}<span class="badge bg-primary">Admin</span>{% endif %}
                                {% if user.teams_as_lead %}
                                    {% for team in user.teams_as_lead %}
                                        <span class="badge bg-info">Lead: {{ team.name }}</span>
                                    {% endfor %}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ url_for('dashboard.user_profile', username=user.full_name) }}" target="_blank" class="btn btn-sm btn-info" title="View booklet"><i class="fa fa-eye"></i></a>
                                <button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="{{ url_for('admin.edit_user', item_id=user.id) }}" title="Edit"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-user-btn" data-user-id="{{ user.id }}" data-delete-url="{{ url_for('admin.delete_user', item_id=user.id) }}" title="Delete"><i class="fa fa-trash"></i></button>
                                <a href="{{ url_for('dashboard.generate_user_booklet_zip', user_id=user.id) }}" target="_blank" class="btn btn-sm btn-secondary" title="Generate PDF"><i class="fa fa-file-pdf"></i></a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Section 3: Skill Management Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
            <h6 class="m-0 font-weight-bold text-primary">Skill Management</h6>
            <div>
                <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#import-skills-modal">Import</button>
                <div class="btn-group">
                    <button type="button" class="btn btn-info btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('admin.export_skills_xlsx') }}">Export Excel</a></li>
                    </ul>
                </div>
                <button class="btn btn-primary btn-sm" id="add-skill-btn">Create a skill</button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="skills-table" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th width="40%">Description</th>
                            <th>Species</th>
                            <th>Tutors</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for skill in skills %}
                        <tr id="skill-row-{{ skill.id }}">
                            <td>{{ skill.name }}</td>
                            <td>{{ (skill.description or '')|truncate(120) }}</td>
                            <td>
                                {% for species in skill.species %}
                                    <span class="badge bg-secondary">{{ species.name }}</span>
                                {% else %}
                                    None
                                {% endfor %}
                            </td>
                            <td>
                                {% for tutor in skill.tutors %}
                                    {% if recycling_map and skill.id in recycling_map.get(tutor.id, []) %}
                                        <span class="badge bg-danger">{{ tutor.full_name }}</span>
                                    {% else %}
                                        <span class="badge bg-dark">{{ tutor.full_name }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-warning">None</span>
                                {% endfor %}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-warning edit-skill-btn" data-edit-url="{{ url_for('admin.edit_skill', item_id=skill.id) }}" title="Edit"><i class="fa fa-edit"></i></button>
                                <button class="btn btn-sm btn-danger delete-skill-btn" data-skill-id="{{ skill.id }}" data-delete-url="{{ url_for('admin.delete_skill', item_id=skill.id) }}" title="Delete"><i class="fa fa-trash"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}


{% block modals %}
    <!-- Modal Placeholder for User Edit -->
    <div class="modal fade" id="user-edit-modal" tabindex="-1" aria-labelledby="user-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="user-edit-modal-label">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- User form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-user-changes-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Edit -->
    <div class="modal fade" id="skill-edit-modal" tabindex="-1" aria-labelledby="skill-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="skill-edit-modal-label">Edit Skill</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Skill form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-skill-changes-btn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for User Import -->
    <div class="modal fade" id="import-users-modal" tabindex="-1" aria-labelledby="import-users-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-users-modal-label">Import Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Skill Import -->
    <div class="modal fade" id="import-skills-modal" tabindex="-1" aria-labelledby="import-skills-modal-label" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="import-skills-modal-label">Import Skills</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Import form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Add -->
    <div class="modal fade" id="team-add-modal" tabindex="-1" aria-labelledby="team-add-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-add-modal-label">Create a Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-team-form-btn">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Add Users to Team -->
    <div class="modal fade" id="add-users-to-team-modal" tabindex="-1" aria-labelledby="add-users-to-team-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="add-users-to-team-modal-label">Add Users to Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Add Users to Team form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-add-users-to-team-form-btn">Add Users</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Placeholder for Team Edit -->
    <div class="modal fade" id="team-edit-modal" tabindex="-1" aria-labelledby="team-edit-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="team-edit-modal-label">Edit Team</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Team edit form will be loaded here via AJAX -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submit-team-edit-form-btn">Save</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}


{% block scripts %}
{{ super() }}
<script>
$(document).ready(function() {
    // --- Setup for DataTables ---
    console.log("Initializing DataTables");
    $('#users-table').DataTable();
    $('#skills-table').DataTable();
    $('#teams-table').DataTable();

    // --- MODAL INITIALIZATION ---
    // Create the Bootstrap Modal objects ONCE when the page loads.
    var userModal = new bootstrap.Modal(document.getElementById('user-edit-modal'));
    var skillModal = new bootstrap.Modal(document.getElementById('skill-edit-modal'));
    var teamAddModal = new bootstrap.Modal(document.getElementById('team-add-modal'));
    var teamEditModal = new bootstrap.Modal(document.getElementById('team-edit-modal'));
    var addUsersToTeamModal = new bootstrap.Modal(document.getElementById('add-users-to-team-modal'));

    // --- User Management ---
    var editingUserRow = null;

    // Handle modal opening for ADDING a user
    $('#add-user-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_user') }}";
        editingUserRow = null;

        fetch(addUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#user-edit-modal-label').text('Create a User');
            $('#user-edit-modal .modal-body').html(`<form id="modal-user-form" action="${addUrl}" method="post" novalidate>${html}</form>`);
            userModal.show();
        })
        .catch(error => { console.error('Error loading user form:', error); alert('Error loading the form.'); });
    });

    // Handle modal opening for EDITING a user
    $('#users-table').on('click', '.edit-user-btn', function() {
        var button = $(this);
        var editUrl = button.data('edit-url');
        editingUserRow = button.closest('tr');
        
        fetch(editUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#user-edit-modal-label').text('Edit User');
            $('#user-edit-modal .modal-body').html(`<form id="modal-user-form" action="${editUrl}" method="post" novalidate>${html}</form>`);
            userModal.show();
        })
        .catch(error => { console.error('Error loading user form:', error); alert('Error loading the form.'); });
    });

    // Handle SAVE button click in the user modal
    $('#save-user-changes-btn').on('click', () => $('#modal-user-form').submit());

    // Handle the user form SUBMISSION via AJAX
    $('#user-edit-modal').on('submit', '#modal-user-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken } })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var user = data.user;
                var table = $('#users-table').DataTable();
                var teamsHtml = user.teams && user.teams.length > 0 ? user.teams.map(name => `<span class="badge bg-secondary">${name}</span>`).join(' ') : 'None';
                var rolesHtml = (user.is_admin ? '<span class="badge bg-primary">Admin</span> ' : '') + 
                                (user.teams_as_lead && user.teams_as_lead.length > 0 ? user.teams_as_lead.map(name => `<span class="badge bg-info">Lead: ${name}</span>`).join(' ') : '');
                var actionsHtml = `<a href="/profile/${user.id}" target="_blank" class="btn btn-sm btn-info" title="View booklet"><i class="fa fa-eye"></i></a> ` +
                                  `<button class="btn btn-sm btn-warning edit-user-btn" data-edit-url="/admin/users/edit/${user.id}" title="Edit"><i class="fa fa-edit"></i></button> ` +
                                  `<button class="btn btn-sm btn-danger delete-user-btn" data-user-id="${user.id}" data-delete-url="/admin/users/delete/${user.id}" title="Delete"><i class="fa fa-trash"></i></button> ` +
                                  `<a href="/profile/${user.id}/booklet.pdf" target="_blank" class="btn btn-sm btn-secondary" title="Generate PDF"><i class="fa fa-file-pdf"></i></a>`;
                
                var rowData = [user.full_name, user.email, teamsHtml, rolesHtml, actionsHtml];

                if (editingUserRow) {
                    table.row(editingUserRow).data(rowData).draw();
                } else {
                    var newNode = table.row.add(rowData).draw().node();
                    $(newNode).attr('id', 'user-row-' + user.id);
                }
                
                userModal.hide();

            } else {
                if (data.form_html) { form.html(data.form_html); } 
                else { alert(data.message || 'Error during save.'); }
            }
        })
        .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
    });

    // Handle AJAX deletion for users
    $('#users-table').on('click', '.delete-user-btn', function() {
        var button = $(this);
        var userId = button.data('user-id');
        var deleteUrl = button.data('delete-url');
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        if (confirm('Are you sure you want to delete this user?')) {
            fetch(deleteUrl, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken } })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#users-table').DataTable().row('#user-row-' + userId).remove().draw();
                } else { alert('Error: ' + (data.message || 'Unknown.')); }
            })
            .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
        }
    });


    // --- Skill Management ---
    var editingSkillRow = null;

    // Handle modal opening for ADDING a skill
    $('#add-skill-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_skill') }}";
        editingSkillRow = null;

        fetch(addUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#skill-edit-modal-label').text('Create a Skill');
            $('#skill-edit-modal .modal-body').html(`<form id="modal-skill-form" action="${addUrl}" method="post" novalidate>${html}</form>`);
            skillModal.show();
        })
        .catch(error => { console.error('Error loading skill form:', error); alert('Error loading the form.'); });
    });
    
    // Handle modal opening for EDITING a skill
    $('#skills-table').on('click', '.edit-skill-btn', function() {
        var button = $(this);
        var editUrl = button.data('edit-url');
        editingSkillRow = button.closest('tr');

        fetch(editUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#skill-edit-modal-label').text('Edit Skill');
            $('#skill-edit-modal .modal-body').html(`<form id="modal-skill-form" action="${editUrl}" method="post" novalidate>${html}</form>`);
            skillModal.show();
        })
        .catch(error => { console.error('Error loading skill form:', error); alert('Error loading the form.'); });
    });

    // Handle SAVE button click in the skill modal
    $('#save-skill-changes-btn').on('click', () => $('#modal-skill-form').submit());

    // Handle the skill form SUBMISSION via AJAX
    $('#skill-edit-modal').on('submit', '#modal-skill-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken } })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                var skill = data.skill;
                var table = $('#skills-table').DataTable();
                var speciesHtml = skill.species && skill.species.length > 0 ? skill.species.map(name => `<span class="badge bg-secondary">${name}</span>`).join(' ') : 'None';
                var tutorsHtml = skill.tutors && skill.tutors.length > 0 ? skill.tutors.map(name => `<span class="badge bg-dark">${name}</span>`).join(' ') : '<span class="badge bg-warning">None</span>';
                var actionsHtml = `<button class="btn btn-sm btn-warning edit-skill-btn" data-edit-url="/admin/skills/edit/${skill.id}" title="Edit"><i class="fa fa-edit"></i></button> ` +
                                  `<button class="btn btn-sm btn-danger delete-skill-btn" data-skill-id="${skill.id}" data-delete-url="/admin/skills/delete/${skill.id}" title="Delete"><i class="fa fa-trash"></i></button>`;
                
                var truncatedDescription = (skill.description || '').substring(0, 120) + ((skill.description || '').length > 120 ? '...' : '');
                var rowData = [skill.name, truncatedDescription, speciesHtml, tutorsHtml, actionsHtml];

                if (editingSkillRow) {
                    table.row(editingSkillRow).data(rowData).draw();
                } else {
                    var newNode = table.row.add(rowData).draw().node();
                    $(newNode).attr('id', 'skill-row-' + skill.id);
                }

                skillModal.hide();
            } else {
                if (data.form_html) { form.html(data.form_html); } 
                else { alert(data.message || 'Error during save.'); }
            }
        })
        .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
    });

    // Handle AJAX deletion for skills
    $('#skills-table').on('click', '.delete-skill-btn', function() {
        var button = $(this);
        var skillId = button.data('skill-id');
        var deleteUrl = button.data('delete-url');
        var csrfToken = $('meta[name=csrf-token]').attr('content');

        if (confirm('Are you sure you want to delete this skill?')) {
            fetch(deleteUrl, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': csrfToken } })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    $('#skills-table').DataTable().row('#skill-row-' + skillId).remove().draw();
                } else { alert('Error: ' + (data.message || 'Unknown.')); }
            })
            .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
        }
    });

    // --- Import Modals ---
    $('#import-users-modal').on('show.bs.modal', function () {
        fetch("{{ url_for('admin.import_export_users') }}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => { $(this).find('.modal-body').html(html); })
        .catch(error => { console.error('Error loading import form:', error); });
    });

    $('#import-skills-modal').on('show.bs.modal', function () {
        fetch("{{ url_for('admin.import_export_skills') }}", { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => { $(this).find('.modal-body').html(html); })
        .catch(error => { console.error('Error loading skill import form:', error); });
    });

    // --- Team Management ---

    // Handle modal opening for ADDING a team
    $('#add-team-btn').on('click', function() {
        var addUrl = "{{ url_for('admin.add_team') }}";
        fetch(addUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#team-add-modal-label').text('Create a Team');
            $('#team-add-modal .modal-body').html(`<form id="modal-team-form" action="${addUrl}" method="post" novalidate>${html}</form>`);
            teamAddModal.show();
        })
        .catch(error => { console.error('Error loading team form:', error); alert('Error loading form.'); });
    });

    // Handle form submission from the team add modal
    $('#team-add-modal').on('submit', '#modal-team-.form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': form.find('input[name=csrf_token]').val() } })
        .then(response => response.json())
        .then(data => {
            if (data.success) { location.reload(); } 
            else {
                if (data.form_html) { form.html(data.form_html); }
                else { alert(data.message || 'Error during creation.'); }
            }
        })
        .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
    });
    $('#submit-team-form-btn').on('click', () => $('#modal-team-form').submit());

    // Handle modal opening for EDITING a team
    $('#teams-table').on('click', '.btn-warning[title="Edit"]', function(e) {
        e.preventDefault();
        var editUrl = $(this).attr('href');

        fetch(editUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#team-edit-modal-label').text('Edit Team');
            $('#team-edit-modal .modal-body').html(`<form id="modal-team-edit-form" action="${editUrl}" method="post" novalidate>${html}</form>`);
            teamEditModal.show();
        })
        .catch(error => { console.error('Error loading team edit form:', error); alert('Error loading form.'); });
    });

    // Handle form submission from the team edit modal
    $('#team-edit-modal').on('submit', '#modal-team-edit-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': form.find('input[name=csrf_token]').val() } })
        .then(response => response.json())
        .then(data => {
            if (data.success) { location.reload(); }
            else {
                if (data.form_html) { form.html(data.form_html); }
                else { alert(data.message || 'Error during update.'); }
            }
        })
        .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
    });
    $('#submit-team-edit-form-btn').on('click', () => $('#modal-team-edit-form').submit());

    // Handle AJAX deletion for teams
    $('#teams-table').on('submit', 'form[action*="delete_team"]', function(e) {
        e.preventDefault();
        var form = $(this);
        if (confirm('Are you sure you want to delete this team?')) {
            fetch(form.attr('action'), { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': form.find('input[name=csrf_token]').val() } })
            .then(response => response.json())
            .then(data => {
                if (data.success) { location.reload(); }
                else { alert('Error: ' + (data.message || 'Unknown.')); }
            })
            .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
        }
    });
    // This makes the button trigger the form submission, which is then caught by the handler above.
    $('#teams-table').on('click', '.btn-danger[title="Delete"]', function(e) {
        e.preventDefault();
        $(this).closest('form').submit();
    });

    // Handle modal opening for ADDING USERS to a team
    $('#teams-table').on('click', '.add-user-to-team-btn', function() {
        var teamId = $(this).data('team-id');
        var teamName = $(this).data('team-name');
        var addUsersUrl = `/admin/team/${teamId}/add_users`;

        fetch(addUsersUrl, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(response => response.text())
        .then(html => {
            $('#add-users-to-team-modal-label').text(`Add users to ${teamName}`);
            $('#add-users-to-team-modal .modal-body').html(html);
            addUsersToTeamModal.show();
        })
        .catch(error => { console.error('Error loading add users form:', error); alert('Error loading form.'); });
    });

    // Handle form submission for adding users to a team
    $('#add-users-to-team-modal').on('submit', '#add-users-to-team-form', function(e) {
        e.preventDefault();
        var form = $(this);
        var url = form.attr('action');
        var formData = new FormData(this);
        fetch(url, { method: 'POST', body: formData, headers: { 'X-Requested-With': 'XMLHttpRequest', 'X-CSRFToken': form.find('input[name=csrf_token]').val() } })
        .then(response => response.json())
        .then(data => {
            if (data.success) { location.reload(); }
            else {
                if (data.form_html) { form.html(data.form_html); }
                else { alert(data.message || 'Error during add.'); }
            }
        })
        .catch(error => { console.error('Error:', error); alert('A network error occurred.'); });
    });
    $('#submit-add-users-to-team-form-btn').on('click', () => $('#add-users-to-team-form').submit());
});
</script>
{% endblock %}